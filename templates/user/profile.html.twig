{% extends 'base.html.twig' %}

{% block body %}
{# Chargement PRIORITAIRE de jQuery pour débloquer le site #}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<div class="container mt-5">
    {# Affichage du message de succès après la mise à jour #}
    {% for message in app.flashes('success') %}
        <div class="alert alert-success alert-dismissible fade show rounded-pill px-4 mb-4" role="alert">
            <i class="fas fa-check-circle me-2"></i> {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    {% endfor %}

    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card shadow-lg p-4" style="border-radius: 30px; background: white; height: 100%;">
                <h3 class="fw-bold text-center mb-4 text-primary">Modifier mon profil</h3>
                
                {{ form_start(form, {'attr': {'novalidate': 'novalidate'}}) }}
                    <div class="mb-3">
                        {{ form_label(form.nom) }}
                        {{ form_widget(form.nom, {'attr': {'class': 'form-control rounded-pill'}}) }}
                        {{ form_errors(form.nom) }}
                    </div>
                    <div class="mb-3">
                        {{ form_label(form.prenom) }}
                        {{ form_widget(form.prenom, {'attr': {'class': 'form-control rounded-pill'}}) }}
                        {{ form_errors(form.prenom) }}
                    </div>
                    <div class="mb-3">
                        {{ form_label(form.email) }}
                        {{ form_widget(form.email, {'attr': {'class': 'form-control rounded-pill'}}) }}
                        {{ form_errors(form.email) }}
                    </div>
                    <div class="mb-3">
                        {{ form_label(form.plainPassword.first) }}
                        {{ form_widget(form.plainPassword.first, {'attr': {'class': 'form-control rounded-pill'}}) }}
                        {{ form_errors(form.plainPassword.first) }}
                    </div>
                    <div class="mb-3">
                        {{ form_label(form.plainPassword.second) }}
                        {{ form_widget(form.plainPassword.second, {'attr': {'class': 'form-control rounded-pill'}}) }}
                        {{ form_errors(form.plainPassword.second) }}
                    </div>

                    <button type="submit" class="btn btn-primary w-100 rounded-pill mt-3">Mettre à jour</button>
                {{ form_end(form) }}
            </div>
        </div>

        <div class="col-md-6 mb-4">
            <div class="card shadow-lg p-5 text-center d-flex flex-column justify-content-center align-items-center" style="border-radius: 30px; background: white; height: 100%; min-height: 450px;">
                <div id="setup-view">
                    <h2 class="fw-bold">Face ID Maternia</h2>
                    <p class="text-muted">Activez la reconnaissance faciale pour votre profil.</p>
                    <button class="btn btn-primary rounded-pill px-5 mt-4" id="start-camera">Démarrer</button>
                </div>

                <div id="scan-view" style="display:none;">
                    <video id="v" width="320" height="320" autoplay muted playsinline style="border-radius: 50%; border: 6px solid #0d6efd; object-fit: cover;"></video>
                    <h4 id="msg" class="mt-4 text-primary fw-bold">Prêt pour l'analyse...</h4>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        // Force la disparition du point rose de chargement
        $('.spinner, #preloader, .loading').fadeOut();

        const btn = document.getElementById('start-camera');
        if (btn) {
            btn.onclick = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    $('#setup-view').hide();
                    $('#scan-view').show();
                    document.getElementById('v').srcObject = stream;
                    setTimeout(captureAndSend, 3000);
                } catch (e) {
                    alert("Caméra bloquée : " + e.message);
                }
            };
        }
    });

    async function captureAndSend() {
        const video = document.getElementById('v');
        const msg = document.getElementById('msg');
        const canvas = document.createElement('canvas');
        
        msg.innerText = "Analyse en cours...";
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);

        canvas.toBlob(blob => {
            const fd = new FormData();
            fd.append('photo', blob, 'face.jpg');

            fetch("{{ path('app_enroll_face') }}", { method: "POST", body: fd })
                .then(async response => {
                    const contentType = response.headers.get("content-type");
                    if (!response.ok || !contentType || !contentType.includes("application/json")) {
                        const text = await response.text();
                        console.error("Réponse serveur (Erreur 500) :", text);
                        throw new Error("Erreur 500 : Le serveur n'a pas pu traiter l'image.");
                    }
                    return response.json();
                })
                .then(res => {
                    if(res.success) {
                        msg.innerHTML = "<span style='color:green'>Succès !</span>";
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        alert("Erreur : " + res.error);
                        location.reload();
                    }
                })
                .catch(err => {
                    alert(err.message);
                    location.reload();
                });
        }, 'image/jpeg');
    }
</script>
{% endblock %}