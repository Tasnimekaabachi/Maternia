{% extends 'base.html.twig' %}

{% block title %}Connexion - Maternia{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .login-page-wrapper {
            background: linear-gradient(-45deg, #e0c3fc, #fbc2eb, #a1c4fd, #c2e9fb);
            background-size: 400% 400%;
            animation: flowingGradient 15s ease infinite;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        @keyframes flowingGradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .auth-card {
            background: #ffffff;
            border-radius: 40px;
            border: none;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.1);
            padding: 50px 40px;
            width: 100%;
            max-width: 450px;
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .auth-card:hover { transform: translateY(-10px); }

        .form-control {
            background-color: #f7fafc !important;
            border: 2px solid transparent !important;
            border-radius: 15px !important;
            padding: 15px 20px !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
        }

        .form-control:hover, .form-control:focus {
            transform: scale(1.02);
            background-color: #ffffff !important;
            border-color: #fbc2eb !important;
            box-shadow: 0 0 0 0.25 margin rgba(251, 194, 235, 0.25) !important;
        }

        .welcome-title { color: #4a5568; font-weight: 700; font-size: 2rem; }
        .welcome-title span { color: #d53f8c; }
        
        .btn-login {
            background: linear-gradient(90deg, #ff6b8b 0%, #f06292 100%);
            border: none;
            border-radius: 20px;
            color: white;
            font-weight: 700;
            padding: 18px;
            box-shadow: 0 10px 20px rgba(255, 107, 139, 0.3);
            transition: all 0.3s ease;
        }

        .btn-face {
            background: #ffffff;
            border: 2px solid #a1c4fd;
            border-radius: 20px;
            color: #718096;
            font-weight: 600;
            padding: 12px;
            transition: all 0.3s ease;
            margin-top: 15px;
        }

        .btn-face:hover {
            background: #f0f7ff;
            color: #a1c4fd;
            transform: scale(1.02);
        }

        #videoContainer {
            position: relative;
            margin-bottom: 20px;
            border-radius: 20px;
            overflow: hidden;
            display: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        #videoLogin {
            width: 100%;
            background: #2d3748;
            transform: scaleX(-1);
        }

        .scan-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 70%;
            height: 70%;
            border: 3px dashed rgba(255,255,255,0.6);
            border-radius: 50%;
            pointer-events: none;
        }

        .forgot-password-link {
            color: #718096;
            font-size: 0.85rem;
            transition: color 0.2s;
        }

        .forgot-password-link:hover {
            color: #d53f8c;
        }
    </style>
{% endblock %}

{% block body %}
<div class="login-page-wrapper">
    <div class="auth-card">
        <div class="text-center mb-4">
            <h2 class="welcome-title">Heureuse de vous <span>revoir !</span></h2>
            <p class="text-muted small">Connectez-vous à votre espace Maternia</p>
        </div>

        {# Zone de Scan Vidéo #}
        <div id="videoContainer">
            <video id="videoLogin" autoplay muted playsinline></video>
            <div class="scan-overlay"></div>
            <p class="small text-center mt-2 text-primary fw-bold" id="scanStatus">Initialisation de la caméra...</p>
        </div>

        <form method="post" id="loginForm" novalidate>
            {% if error %}
                <div class="alert alert-danger text-center small" style="border-radius: 15px;">{{ error.messageKey|trans(error.messageData, 'security') }}</div>
            {% endif %}

            <div class="mb-4">
                <label for="inputEmail" class="label-custom small fw-bold text-muted mb-2">Email</label>
                <input type="email" value="{{ last_username }}" name="email" id="inputEmail" class="form-control" autocomplete="email" required autofocus placeholder="maman@exemple.com">
            </div>

            <div class="mb-2">
                <label for="inputPassword" class="label-custom small fw-bold text-muted mb-2">Mot de passe</label>
                <input type="password" name="password" id="inputPassword" class="form-control" autocomplete="current-password" required placeholder="••••••••">
            </div>

            {# Lien Mot de passe oublié réintégré #}
            <div class="text-end mb-4">
                <a href="{{ path('app_forgot_password') }}" class="forgot-password-link text-decoration-none">
                    Mot de passe oublié ?
                </a>
            </div>

            <input type="hidden" name="_csrf_token" value="{{ csrf_token('authenticate') }}">

            <button class="btn btn-login w-100 mb-3" type="submit">
                Se connecter <i class="fas fa-sign-in-alt ms-2"></i>
            </button>

            <div class="divider d-flex align-items-center my-4">
                <hr class="flex-grow-1" style="color: #cbd5e0;">
                <span class="mx-3 text-muted small uppercase">ou</span>
                <hr class="flex-grow-1" style="color: #cbd5e0;">
            </div>

            <button type="button" class="btn btn-face w-100" id="btnFaceScan" onclick="startFaceLogin()">
                <i class="fas fa-video me-2 text-primary"></i> Se connecter par Face Scan
            </button>

            <div class="text-center mt-4">
                <p class="small text-muted">Pas encore membre ? <a href="{{ path('app_register') }}" class="fw-bold text-decoration-none" style="color: #d53f8c;">Créer un compte</a></p>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        async function startFaceLogin() {
            const videoContainer = document.getElementById('videoContainer');
            const video = document.getElementById('videoLogin');
            const status = document.getElementById('scanStatus');
            const loginForm = document.getElementById('loginForm');

            loginForm.style.display = 'none';
            videoContainer.style.display = 'block';

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                status.innerText = "Cadrez votre visage dans le cercle...";

                setTimeout(() => {
                    const canvas = document.createElement('canvas');
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    canvas.getContext('2d').drawImage(video, 0, 0);

                    canvas.toBlob(blob => {
                        const formData = new FormData();
                        formData.append('photo', blob, 'login.jpg');

                        status.innerText = "Identification en cours...";

                        // On pointe vers la route app_check_face définie dans le SecurityController
                        fetch("{{ path('app_check_face') }}", {
                            method: "POST",
                            body: formData
                        }).then(response => response.json())
                        .then(res => {
                            if (res.success) {
                                status.innerText = "Succès ! Redirection...";
                                window.location.href = "{{ path('app_user_profile') }}";
                            } else {
                                alert("Erreur : " + res.error);
                                location.reload();
                            }
                        }).catch(err => {
                            alert("Erreur serveur : " + err.message);
                            location.reload();
                        });
                    }, 'image/jpeg');
                }, 3000); // 3 secondes pour bien se placer

            } catch (err) {
                alert("Impossible d'accéder à la caméra : " + err.message);
                location.reload();
            }
        }
    </script>
{% endblock %}