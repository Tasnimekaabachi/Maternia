{% extends 'admin/base.html.twig' %}

{% block title %}Gestion des créneaux{% endblock %}
{% block page_title %}Créneaux de consultation{% endblock %}

{% block stylesheets %}
<style>
    /* DESIGN PREMIUM FÉMININ & ÉLÉGANT */
    :root {
        --primary-pink: #FF8AAB;
        --soft-pink: #FFD1DC;
        --deep-pink: #FF5C8D;
        --rose-gold: #E5A29D;
        --lavender: #E1BEE7;
        --glass-white: rgba(255, 255, 255, 0.95);
        --gradient-feminine: linear-gradient(135deg, #FF8AAB 0%, #E1BEE7 100%);
        --gradient-soft: linear-gradient(135deg, #FFF5F5 0%, #FCE4EC 100%);
        --gradient-stat-1: linear-gradient(135deg, #FF8AAB 0%, #FFB6C1 100%);
        --gradient-stat-2: linear-gradient(135deg, #FFD1DC 0%, #FFF5F5 100%);
        --gradient-stat-3: linear-gradient(135deg, #E1BEE7 0%, #F3E5F5 100%);
    }

    .index-container {
        background: var(--gradient-soft);
        min-height: 100vh;
        padding: 2rem 0;
    }

    .stat-card-premium {
        background: white;
        border-radius: 20px;
        padding: 1.5rem;
        border: 1px solid #FCE4EC;
        box-shadow: 0 10px 25px rgba(255, 138, 171, 0.05);
        transition: all 0.3s ease;
        text-align: center;
        position: relative;
        overflow: hidden;
    }

    .stat-card-premium .label {
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        color: #A0A0A0;
        margin-bottom: 0.25rem;
    }

    .stat-card-premium .value {
        font-size: 2rem;
        font-weight: 800;
        color: #4A4A4A;
    }

    /* RECHERCHE & TRIS (DESIGN SPÉCIFIQUE) */
    .search-box {
        position: relative;
        display: flex;
        align-items: center;
    }
    .search-box i {
        position: absolute;
        left: 12px;
        color: #9ca3af;
        font-size: 0.85rem;
    }
    .search-input {
        border: 2px solid #e5e7eb;
        border-radius: 25px;
        padding: 6px 14px 6px 34px;
        font-size: 0.85rem;
        width: 200px;
        transition: all 0.3s;
        outline: none;
        background: #fafbfc;
    }
    .search-input:focus {
        border-color: var(--primary-pink);
        width: 260px;
        background: white;
        box-shadow: 0 0 0 3px rgba(255, 138, 171, 0.1);
    }

    .sort-group { display: flex; gap: 4px; }
    .sort-btn {
        border: 2px solid #e5e7eb;
        background: white;
        border-radius: 8px;
        padding: 5px 10px;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 4px;
        color: #6b7280;
    }
    .sort-btn:hover { border-color: var(--primary-pink); color: var(--primary-pink); }
    .sort-btn.active {
        background: var(--gradient-feminine);
        color: white;
        border-color: transparent;
    }
    .sort-arrow { font-size: 0.7rem; }

    .admin-card {
        background: white;
        border-radius: 24px;
        border: 1px solid #FCE4EC;
        box-shadow: 0 15px 35px rgba(255, 138, 171, 0.05);
        overflow: hidden;
        margin-top: 2rem;
    }

    .admin-card-header {
        padding: 1.25rem 2rem;
        border-bottom: 1px solid #FCE4EC;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .premium-table th {
        background: #FDF2F8;
        padding: 1rem 1.5rem;
        text-transform: uppercase;
        font-size: 0.7rem;
        font-weight: 700;
        letter-spacing: 1px;
        color: #db2777;
    }

    .premium-table td {
        padding: 1.25rem 1.5rem;
        vertical-align: middle;
        border-bottom: 1px solid #F3E5F5;
        font-size: 0.9rem;
    }

    .doctor-profile {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .pdp-wrapper {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        overflow: hidden;
        border: 2px solid white;
        box-shadow: 0 3px 8px rgba(255, 138, 171, 0.2);
        background: var(--gradient-feminine);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
    }

    .pdp-wrapper img { width: 100%; height: 100%; object-fit: cover; }

    .badge-pink-soft {
        background: #FCE4EC;
        color: #db2777;
        border: 1px solid #fbcfe8;
        padding: 4px 12px;
        border-radius: 50px;
        font-weight: 600;
        font-size: 0.75rem;
    }

    .time-badge {
        display: inline-flex;
        flex-direction: column;
        padding: 4px 10px;
        border-radius: 10px;
        min-width: 70px;
        text-align: center;
    }
    .time-badge.debut { background: #E8F5E9; color: #2E7D32; border: 1px solid #C8E6C9; }
    .time-badge.fin { background: #FFF5F5; color: #D32F2F; border: 1px solid #FFCDD2; }
    .time-badge .label { font-size: 0.55rem; text-transform: uppercase; font-weight: 800; }
    .time-badge .value { font-size: 0.85rem; font-weight: 700; }

    .btn-action-circle {
        width: 32px; height: 32px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center;
        background: white; border: 1px solid #FCE4EC; transition: all 0.2s; text-decoration: none; font-size: 0.8rem;
    }
    .btn-action-view { color: #4dabf7; }
    .btn-action-edit { color: #FF8AAB; }
    .btn-action-delete { color: #fa5252; }
    .btn-action-circle:hover { background: #FDF2F8; transform: scale(1.1); }

    .btn-feminine {
        background: var(--gradient-feminine);
        color: white;
        border-radius: 50px;
        padding: 0.6rem 1.5rem;
        font-weight: 700;
        border: none;
        box-shadow: 0 5px 15px rgba(255, 138, 171, 0.2);
    }
    .btn-feminine:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(255, 138, 171, 0.3); color: white; }

    .statut-badge {
        padding: 4px 10px;
        border-radius: 50px;
        font-weight: 700;
        font-size: 0.7rem;
    }
    .statut-dispo { background: #E8F5E9; color: #2E7D32; }
    .statut-reserve { background: #FFF3E0; color: #E65100; }
</style>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
{% endblock %}

{% block header_actions %}
<div class="d-flex gap-2">
    <button onclick="exportPDF()" class="btn btn-outline-danger" style="border-radius: 8px; font-weight: 600; padding: 0.5rem 1rem;">
        <i class="fas fa-file-pdf me-1"></i> PDF
    </button>
    <a href="{{ path('app_admin_consultation_creneau_new') }}" class="btn btn-feminine">
        <i class="fas fa-plus-circle me-1"></i> Nouveau créneau
    </a>
</div>
{% endblock %}

{% block content %}
<div class="index-container">
    <div class="container">
        {# STATS #}
        <div class="row g-3 mb-4">
            {% set total = creneaux|length %}
            {% set dispo = creneaux|filter(c => c.statutReservation == 'DISPONIBLE')|length %}
            {% set res = total - dispo %}
            
            <div class="col-md-4">
                <div class="stat-card-premium">
                    <div class="label">Total Créneaux</div>
                    <div class="value">{{ total }}</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card-premium" style="border-bottom: 3px solid #4CAF50;">
                    <div class="label" style="color: #4CAF50;">Disponibles</div>
                    <div class="value">{{ dispo }}</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card-premium" style="border-bottom: 3px solid #FF5252;">
                    <div class="label" style="color: #FF5252;">Réservés</div>
                    <div class="value">{{ res }}</div>
                </div>
            </div>
        </div>

        <div class="admin-card">
            <div class="admin-card-header">
                <h5 class="mb-0 fw-bold">Gestion des rendez-vous</h5>
                <div class="d-flex gap-3 align-items-center">
                    {# RECHERCHE #}
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="creneauSearch" class="search-input" placeholder="Rechercher...">
                    </div>
                    {# TRIS #}
                    <div class="sort-group">
                        <button class="sort-btn active" onclick="sortTable(0, this)" title="Trier par médecin">
                            <i class="fas fa-user-md"></i> <i class="fas fa-arrow-up sort-arrow"></i>
                        </button>
                        <button class="sort-btn" onclick="sortTable(1, this)" title="Trier par date">
                            <i class="fas fa-calendar-alt"></i> <i class="fas fa-arrow-up sort-arrow"></i>
                        </button>
                    </div>
                    <span class="badge bg-danger rounded-pill px-3">{{ total }}</span>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table premium-table" id="slotsTable">
                    <thead>
                        <tr>
                            <th>Médecin & Type</th>
                            <th>Jour</th>
                            <th>Début</th>
                            <th>Fin</th>
                            <th class="text-center">Statut</th>
                            <th class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for creneau in creneaux %}
                        <tr class="creneau-row">
                            <td>
                                <div class="doctor-profile">
                                    <div class="pdp-wrapper">
                                        {% if creneau.photoMedecin %}
                                            {% if creneau.photoMedecin starts with 'http' %}
                                                <img src="{{ creneau.photoMedecin }}" alt="{{ creneau.nomMedecin }}">
                                            {% else %}
                                                <img src="{{ asset('uploads/medecins/' ~ creneau.photoMedecin) }}" alt="{{ creneau.nomMedecin }}">
                                            {% endif %}
                                        {% else %}
                                            {{ creneau.nomMedecin|slice(0, 1)|upper }}
                                        {% endif %}
                                    </div>
                                    <div class="d-flex flex-column">
                                        <span class="fw-bold">{{ creneau.nomMedecin }}</span>
                                        <span class="small text-muted">{{ creneau.consultation.categorie }}</span>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="badge-pink-soft">
                                    <i class="far fa-calendar-alt me-2"></i>
                                    {{ creneau.jour ? creneau.jour|date('d/m/Y') : (creneau.dateDebut ? creneau.dateDebut|date('d/m/Y') : '-') }}
                                </span>
                            </td>
                            <td>
                                <div class="time-badge debut">
                                    <span class="label">H. Début</span>
                                    <span class="value">{{ creneau.heureDebut ? creneau.heureDebut|date('H:i') : '-' }}</span>
                                </div>
                            </td>
                            <td>
                                <div class="time-badge fin">
                                    <span class="label">H. Fin</span>
                                    <span class="value">{{ creneau.heureFin ? creneau.heureFin|date('H:i') : '-' }}</span>
                                </div>
                            </td>
                            <td class="text-center">
                                <span class="statut-badge {% if creneau.statutReservation == 'DISPONIBLE' %}statut-dispo{% else %}statut-reserve{% endif %}">
                                    {{ creneau.statutReservation }}
                                </span>
                            </td>
                            <td class="text-end">
                                <div class="d-flex justify-content-end gap-2">
                                    <a href="{{ path('app_admin_consultation_creneau_show', {'id': creneau.id}) }}" class="btn-action-circle btn-action-view"><i class="fas fa-eye"></i></a>
                                    <a href="{{ path('app_admin_consultation_creneau_edit', {'id': creneau.id}) }}" class="btn-action-circle btn-action-edit"><i class="fas fa-pen"></i></a>
                                    <button class="btn-action-circle btn-action-delete" title="Supprimer" onclick="confirmDelete('{{ path('app_admin_consultation_creneau_delete', {'id': creneau.id}) }}', '{{ csrf_token('delete' ~ creneau.id) }}', this.closest('tr'))"><i class="fas fa-trash"></i></button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

{# PDF CONTENT #}
<div id="pdfContent" style="display: none;">
    <div style="padding: 40px; font-family: sans-serif;">
        <h1 style="color: #FF8AAB;">Rapport des Créneaux - Maternia</h1>
        <hr>
        <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
            <thead>
                <tr style="background: #FDF2F8;">
                    <th style="padding: 10px; border: 1px solid #EEE;">Médecin</th>
                    <th style="padding: 10px; border: 1px solid #EEE;">Date</th>
                    <th style="padding: 10px; border: 1px solid #EEE;">Début</th>
                    <th style="padding: 10px; border: 1px solid #EEE;">Statut</th>
                </tr>
            </thead>
            <tbody>
                {% for c in creneaux %}
                <tr>
                    <td style="padding: 10px; border: 1px solid #EEE;">{{ c.nomMedecin }}</td>
                    <td style="padding: 10px; border: 1px solid #EEE;">{{ c.jour ? c.jour|date('d/m/Y') : '-' }}</td>
                    <td style="padding: 10px; border: 1px solid #EEE;">{{ c.heureDebut ? c.heureDebut|date('H:i') : '-' }}</td>
                    <td style="padding: 10px; border: 1px solid #EEE;">{{ c.statutReservation }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    // RECHERCHE
    document.getElementById('creneauSearch').addEventListener('keyup', function() {
        const q = this.value.toLowerCase();
        document.querySelectorAll('.creneau-row').forEach(row => {
            row.style.display = row.textContent.toLowerCase().includes(q) ? '' : 'none';
        });
    });

    // TRI
    function sortTable(n, btn) {
        const table = document.getElementById("slotsTable");
        let switching = true, i, x, y, shouldSwitch, dir = "asc", switchcount = 0;
        
        document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const arrow = btn.querySelector('.sort-arrow');

        while (switching) {
            switching = false;
            const rows = table.rows;
            for (i = 1; i < (rows.length - 1); i++) {
                shouldSwitch = false;
                x = rows[i].getElementsByTagName("TD")[n];
                y = rows[i+1].getElementsByTagName("TD")[n];
                if (dir == "asc") {
                    if (x.textContent.toLowerCase() > y.textContent.toLowerCase()) { shouldSwitch = true; break; }
                } else {
                    if (x.textContent.toLowerCase() < y.textContent.toLowerCase()) { shouldSwitch = true; break; }
                }
            }
            if (shouldSwitch) {
                rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                switching = true;
                switchcount++;
            } else if (switchcount == 0 && dir == "asc") {
                dir = "desc";
                switching = true;
                arrow.className = "fas fa-arrow-down sort-arrow";
            } else if (dir == "desc") {
                arrow.className = "fas fa-arrow-down sort-arrow";
            } else {
                arrow.className = "fas fa-arrow-up sort-arrow";
            }
        }
    }

    // PDF
    function exportPDF() {
        const element = document.getElementById('pdfContent');
        element.style.display = 'block';
        html2pdf().from(element).set({
            margin: 10, filename: 'maternia_creneaux.pdf',
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        }).save().then(() => element.style.display = 'none');
    }

    // DELETE
    function confirmDelete(url, token, row) {
        Swal.fire({
            title: 'Action Irréversible ?', text: "Ce créneau sera supprimé définitivement.",
            icon: 'warning', showCancelButton: true, confirmButtonColor: '#FF5C8D', cancelButtonColor: '#B0B0B0',
            confirmButtonText: 'Oui, supprimer', borderRadius: '24px'
        }).then((result) => {
            if (result.isConfirmed) {
                const formData = new FormData(); formData.append('_token', token);
                fetch(url, { method: 'POST', body: formData, headers: {'X-Requested-With': 'XMLHttpRequest'} })
                .then(r => r.json()).then(data => {
                    if (data.success) {
                        row.classList.add('animate__animated', 'animate__fadeOutLeft');
                        setTimeout(() => row.remove(), 500);
                        Swal.fire({ title: '✨ Supprimé !', icon: 'success', timer: 1500, showConfirmButton: false });
                    }
                });
            }
        });
    }
</script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
{% endblock %}