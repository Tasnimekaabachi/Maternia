{% extends 'admin/base.html.twig' %}

{% block title %}Marketplace{% endblock %}
{% block page_title %}Marketplace{% endblock %}

{% block stylesheets %}
<style>
    .search-box { position: relative; display: flex; align-items: center; }
    .search-box i { position: absolute; left: 12px; color: #9ca3af; font-size: 0.85rem; }
    .search-input {
        border: 2px solid #e5e7eb; border-radius: 25px; padding: 6px 14px 6px 34px;
        font-size: 0.85rem; width: 180px; transition: all 0.3s; outline: none; background: #fafbfc;
    }
    .search-input:focus { border-color: #FF8AAB; width: 240px; background: white; }
</style>
{% endblock %}

{% block breadcrumb %}
    <div class="admin-breadcrumb">
        <a href="{{ path('admin_dashboard') }}">Backoffice</a>
        <span>/</span>
        <span>Marketplace</span>
    </div>
{% endblock %}

{% block header_actions %}
    <a href="{{ path('app_commande_index') }}" class="btn btn-outline-primary me-2">
        <i class="fas fa-list me-1"></i> Voir les commandes
    </a>
    <a href="{{ path('app_commande_export') }}" class="btn btn-outline-secondary me-2">
        <i class="fas fa-file-csv me-1"></i> Exporter commandes CSV
    </a>
    <a href="{{ path('admin_produit_export') }}" class="btn btn-outline-secondary me-2">
        <i class="fas fa-file-csv me-1"></i> Exporter produits CSV
    </a>
    <a href="{{ path('admin_produit_add') }}" class="btn btn-primary admin-btn-primary">
        <i class="fas fa-plus me-1"></i> Ajouter un produit
    </a>
{% endblock %}

{% block content %}
<div class="admin-card">
    <div class="admin-card-header">Produits & services</div>
    <div class="admin-card-body p-0">
        <div class="p-3 border-bottom">
            <form method="get" action="{{ path('admin_marketplace') }}" class="row g-2 align-items-center">
                <div class="col-md-4">
                    <input
                        type="text"
                        name="q"
                        class="form-control"
                        placeholder="Rechercher un produit..."
                        value="{{ searchTerm ?? '' }}"
                    >
                </div>
                <div class="col-md-4">
                    <select name="sort" class="form-select">
                        <option value="">Tri par défaut</option>
                        <option value="price_asc" {{ sort == 'price_asc' ? 'selected' : '' }}>Prix croissant</option>
                        <option value="price_desc" {{ sort == 'price_desc' ? 'selected' : '' }}>Prix décroissant</option>
                        <option value="name_asc" {{ sort == 'name_asc' ? 'selected' : '' }}>Nom A → Z</option>
                        <option value="name_desc" {{ sort == 'name_desc' ? 'selected' : '' }}>Nom Z → A</option>
                    </select>
                </div>
                <div class="col-md-4 text-md-end">
                    <button type="submit" class="btn btn-primary me-2">
                        <i class="fas fa-filter me-1"></i> Filtrer
                    </button>
                    <a href="{{ path('admin_marketplace') }}" class="btn btn-outline-secondary">
                        Réinitialiser
                    </a>
                </div>
            </form>
        </div>
        <div class="table-responsive">
            <table class="admin-table">
                <thead>
                <tr>
                    <th>Produit / Service</th>
                    <th>Description</th>
                    <th>Prix</th>
                    <th>Stock</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody>

                {% for produit in produits %}
                    <tr>
                        <td>{{ produit.nom }}</td>
                        <td>{{ produit.description }}</td>
                        <td>{{ produit.prix }} DT</td>
                        <td>{{ produit.stock }}</td>
                        <td class="d-flex gap-1">
                            <a href="{{ path('admin_produit_edit', {id: produit.id}) }}" class="btn btn-sm btn-primary">
                                <i class="fas fa-edit"></i>
                            </a>
                            <form method="post" action="{{ path('admin_produit_delete', {id: produit.id}) }}" style="display:inline-block" onsubmit="return confirm('Supprimer ce produit ?')">
                                <input type="hidden" name="_token" value="{{ csrf_token('delete_admin_produit' ~ produit.id) }}">
                                <button class="btn btn-sm btn-danger" type="submit">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </form>
                        </td>
                    </tr>
                {% else %}
                    <tr>
                        <td colspan="5" class="text-center py-4">
                            Aucun produit ou service pour le moment.
                        </td>
                    </tr>
                {% endfor %}

                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
<script>
    const adminSearch = document.getElementById('adminSearch');
    if (adminSearch) {
        adminSearch.addEventListener('input', function() {
            const q = this.value.toLowerCase();
            document.querySelectorAll('.admin-table tbody tr').forEach(row => {
                if (row.querySelector('.admin-empty')) return;
                row.style.display = row.textContent.toLowerCase().includes(q) ? '' : 'none';
            });
        });
    }
</script>
{% endblock %}
